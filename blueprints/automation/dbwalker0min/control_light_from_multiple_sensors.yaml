blueprint:
  name: Control a light from multiple presense sensors
  description: >
    TBD
  domain: automation

input:
  people_sensors:
    name: Motion / presence sensors
    selector:
      entity:
        domain: binary_sensor
        device_class:
          - motion
          - occupancy
          - presence
        multiple: true
  light_entity:
    name: Light to control
    selector:
      entity:
        domain: light
  no_motion_for:
    name: No-motion duration (minutes)
    selector:
      number:
        min: 0
        max: 120
        mode: box
        step: 1
    default: 5

variables:
  sensors: !input people_sensors
  off_minutes: !input no_motion_for

triggers:
  - trigger: state
    entity_id: !input people_sensors
    to: "on"
    id: on_trigger
  - trigger: state
    entity_id: !input people_sensors
    to: "off"
    for:
      minutes: !input no_motion_for
    id: off_trigger

action:
  - choose:
      - conditions:
          - condition: trigger
            id: on_trigger
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_entity
      - conditions:
          - condition: trigger
            id: off_trigger
          - condition: template
            value_template: >
              {{ expand(sensors) | selectattr('state', 'eq', 'on') | list | count == 0 }}
        sequence:
          - service: light.turn_off
            target:
              entity_id: !input light_entity
      - default:
          - service: light.turn_on
            target:
              entity_id: !input light_entity

conditions:
